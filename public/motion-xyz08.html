<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myMotionDetector</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.9/dist/tf-tflite.min.js"></script>
</head>
<body>

    <div id="myContainer">
        <h1 style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px; text-align: center;">Mobile Motion Detector</h1>
        
        <p id="myStatusMessage" class="myStatus">Load a model to check device motion capabilities.</p>

        <div id="myCurrentData">Waiting for sensor data...</div>
        
        <div id="myControls">
            
            <button class="myButton" onclick="myLoadFromDefaultUrl()">1. Load Default Model</button>

            <div class="myGroup">
                <p style="font-weight: bold;">2. Load From Custom URL:</p>
                <input type="text" id="myUrlInput" class="myInput" placeholder="Enter .tflite URL here" style="margin-top: 8px;">
                <button class="myButton" onclick="myLoadFromCustomUrl()">Load Custom URL and Start Motion Detection</button>
            </div>

            <button class="myButton" onclick="myResetApplication()" style="margin-top: 25px;">Reset / Stop Motion Sensing</button>
            
        </div>
    </div>
    
    <div id="myDiv01">Detection not active.</div>

    <script>
        // =================================================================
        // 🚀 USER-CONFIGURABLE MODEL SETTINGS 
        // Note: Set back to original values. Update 'myWindowLength' to 11 
        // if your model truly requires the [1, 33] input shape.
        // =================================================================
        const myModelConfig = {
            // Default URL pointing to the user-specified local repository path
            myDefaultUrl: './tflite/ei-w7-8-esp32-accel-words-both-better-nn-classifier-tensorflow-lite-float32-model.38.tflite', 
            
            // Expected length of the motion window
            myWindowLength: 200, 
            
            // Expected features (X, Y, Z for accelerometer)
            myFeatureCount: 3, 

            // Labels matching the model's 9 outputs
            myLabels: ['D', 'O', 'R', 'S', 'W', 'erase', 'space', 'still', 'unknown'], 
        };

        // =================================================================
        // ⚙️ INTERNAL VARIABLES 
        // =================================================================
        let myTfLiteModel = null;
        let mySensorBuffer = []; 
        let myIsCapturing = false;

        let myStatusElement = null;
        let myPredictionElement = null; 
        let myDataDisplayElement = null;
        let myUrlInput = null;

        // =================================================================
        // 🏠 HTML SETUP (Simple DOM Creation)
        // =================================================================
        
        /**
         * @function myCreateDOM
         * Initializes all necessary DOM element references.
         */
        function myCreateDOM() {
            // Get references to existing static elements
            myStatusElement = document.getElementById('myStatusMessage');
            myDataDisplayElement = document.getElementById('myCurrentData');
            myUrlInput = document.getElementById('myUrlInput');
            
            // Get reference to the dedicated output myDiv01
            myPredictionElement = document.getElementById('myDiv01'); 
            myPredictionElement.textContent = 'Detection not active.';
            
            // Set initial URL value
            myUrlInput.value = myModelConfig.myDefaultUrl;
        }
        
        // Call the setup function when the window loads
        window.onload = myCreateDOM; 

        // =================================================================
        // 💻 MODEL LOADING AND STARTUP LOGIC
        // =================================================================
        
        /**
         * @function myDisableControls
         * Disables control elements during loading.
         */
        function myDisableControls(myDisabled) {
            document.querySelectorAll('.myButton, .myInput').forEach(myEl => myEl.disabled = myDisabled);
        }

        /**
         * @function myLoadFromDefaultUrl
         * Wrapper function to load the model from the configured default URL.
         */
        async function myLoadFromDefaultUrl() {
            await myLoadModelAndStartSensors(myModelConfig.myDefaultUrl);
        }

        /**
         * @function myLoadFromCustomUrl
         * Wrapper function to load the model from the text input URL.
         */
        async function myLoadFromCustomUrl() {
            const myCustomUrl = myUrlInput.value.trim();
            if (myCustomUrl) {
                await myLoadModelAndStartSensors(myCustomUrl);
            } else {
                myStatusElement.textContent = 'Error: Please enter a valid URL in the custom URL field.';
            }
        }

        /**
         * @function myLoadModelAndStartSensors
         * Main function to load the model and start motion sensing, now with iOS permission handling.
         * @param {string} myUrl - The TFLite model URL.
         */
        async function myLoadModelAndStartSensors(myUrl) {
            myStopMotionSensing(); 
            myDisableControls(true);
            
            myStatusElement.textContent = `Loading model from URL: ${myUrl.split('/').pop()}...`;
            
            try {
                // Check for motion sensor capability first
                if (!window.DeviceMotionEvent) {
                    throw new Error('DeviceMotionEvent not supported on this device or browser.');
                }

                // 1. Load Model
                myTfLiteModel = await tflite.loadTFLiteModel(myUrl);
                
                myStatusElement.textContent = 'Model loaded successfully! Starting motion capture...';
                console.log(`TFLite Motion Model Loaded from: ${myUrl}`);

                // 2. Request Permissions (Crucial for iOS 13+ in Safari/WebView)
                // This request must follow a user gesture (the button click).
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Motion sensor permission denied by user on iOS/iPadOS.');
                    }
                }
                
                // 3. Start Sensing
                myStartMotionSensing();
                myDisableControls(false); 

            } catch (myError) {
                myStatusElement.textContent = `Error: ${myError.message}. Motion detection cannot start.`;
                console.error('Model or Sensor error:', myError);
                myDisableControls(false);
            }
        }

        // =================================================================
        // 📱 MOTION SENSING AND INFERENCE LOOP
        // =================================================================
        
        /**
         * @function myStartMotionSensing
         * Adds the event listener to start capturing device motion data.
         */
        function myStartMotionSensing() {
            if (myIsCapturing) return;

            window.addEventListener('devicemotion', myHandleMotion);
            myIsCapturing = true;
            myStatusElement.textContent = `Capturing motion (0/${myModelConfig.myWindowLength} samples collected). Move your device!`;
            myPredictionElement.textContent = 'Collecting data...';
        }

        /**
         * @function myHandleMotion
         * Processes incoming sensor data and buffers it for inference.
         * @param {DeviceMotionEvent} myEvent - The device motion event object.
         */
        function myHandleMotion(myEvent) {
            if (!myTfLiteModel) return;

            const myAcceleration = myEvent.accelerationIncludingGravity;
            
            if (!myAcceleration || myAcceleration.x === null) {
                // Sensor data is unavailable or permission was not granted
                myStatusElement.textContent = 'Sensor data unavailable. Ensure permissions are granted and device supports acceleration data.';
                return;
            }

            // Extract G-force data for X, Y, Z
            const myX = myAcceleration.x || 0;
            const myY = myAcceleration.y || 0;
            const myZ = myAcceleration.z || 0;

            // Push the [X, Y, Z] feature vector to the buffer
            mySensorBuffer.push(myX, myY, myZ);

            // Update UI with current values
            myDataDisplayElement.innerHTML = 
                `**Current Sensor Reading:**<br>` +
                `X: ${myX.toFixed(3)} G | Y: ${myY.toFixed(3)} G | Z: ${myZ.toFixed(3)} G` +
                `<br>Buffer: ${mySensorBuffer.length / myModelConfig.myFeatureCount}/${myModelConfig.myWindowLength} samples`;


            // Check if buffer is full
            if (mySensorBuffer.length >= myModelConfig.myWindowLength * myModelConfig.myFeatureCount) {
                myRunInference();
                // Reset buffer for the next window
                mySensorBuffer = []; 
                myStatusElement.textContent = `Capturing motion (0/${myModelConfig.myWindowLength} samples collected). Move your device!`;
            }
        }

        /**
         * @function myRunInference
         * Runs the TFLite model on the collected time series data.
         */
        function myRunInference() {
            tf.tidy(() => {
                // 1. Prepare Input Tensor
                const myInputArray = new Float32Array(mySensorBuffer);

                // Reshape to [1, window_length, feature_count]
                // (Change to .reshape([1, myInputArray.length]) if myWindowLength = 11 for [1, 33])
                const myInputTensor = tf.tensor(myInputArray)
                    .reshape([1, myModelConfig.myWindowLength, myModelConfig.myFeatureCount]);

                // 2. Run Inference
                const myOutputTensor = myTfLiteModel.predict(myInputTensor);

                // 3. Post-processing (Classification)
                myPostProcessClassification(myOutputTensor);
            }); 
        }
        
        /**
         * @function myPostProcessClassification
         * Interprets the classification output tensor and displays the result in myDiv01.
         */
        function myPostProcessClassification(myOutputTensor) {
            const myProbabilities = myOutputTensor.dataSync();
            const myBestIndex = myProbabilities.indexOf(Math.max(...myProbabilities));
            const myBestLabel = myModelConfig.myLabels[myBestIndex];
            const myConfidence = myProbabilities[myBestIndex];

            let myDisplayResult = `${myBestLabel.toUpperCase()} detected! (${(myConfidence * 100).toFixed(1)}%)`;
            
            // Console output for debugging (optional for mobile)
            console.log(
                `Motion Detected: ${myBestLabel} | Confidence: ${myConfidence.toFixed(4)}`
            );
            
            // Output to the dedicated div (myDiv01)
            myPredictionElement.textContent = myDisplayResult;
        }
        
        /**
         * @function myResetApplication
         * Stops motion sensing and resets the application state.
         */
        function myResetApplication() {
            myStopMotionSensing();
            myTfLiteModel = null;
            
            myPredictionElement.textContent = 'Detection not active.';
            myStatusElement.textContent = 'Application Reset. Load model and start sensing.';
            myDataDisplayElement.textContent = 'Waiting for sensor data...';
            myDisableControls(false); 
            console.log('Motion Detector app reset.');
        }

        /**
         * @function myStopMotionSensing
         * Removes the event listener to stop capturing device motion data.
         */
        function myStopMotionSensing() {
            window.removeEventListener('devicemotion', myHandleMotion);
            myIsCapturing = false;
            mySensorBuffer = [];
        }
    </script>
</body>
</html>
