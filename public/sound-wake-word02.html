<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>myWakeWordDetector</title>

Â  Â  <!-- Minimal, Simple CSS - Using teal/blue for audio theme -->
Â  Â  <style>
Â  Â  Â  Â  /* General Layout */
Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  font-family: Arial, sans-serif;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  margin: 20px;Â 
Â  Â  Â  Â  Â  Â  background-color: #f0f0f0;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #myContainer {Â 
Â  Â  Â  Â  Â  Â  max-width: 480px;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  background: white;Â 
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Buttons */
Â  Â  Â  Â  .myButton {Â 
Â  Â  Â  Â  Â  Â  background-color: #008080; /* Teal */
Â  Â  Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  Â  Â  padding: 10px 15px;Â 
Â  Â  Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  font-size: 16px;Â 
Â  Â  Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .myButton:hover {Â 
Â  Â  Â  Â  Â  Â  background-color: #006666;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .myButton:disabled {Â 
Â  Â  Â  Â  Â  Â  background-color: #ccc;Â 
Â  Â  Â  Â  Â  Â  cursor: not-allowed;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Status and Input */
Â  Â  Â  Â  .myStatus {Â 
Â  Â  Â  Â  Â  Â  margin-top: 10px;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  padding: 10px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  background-color: #f0ffff;
Â  Â  Â  Â  Â  Â  border: 1px solid #b3cccc;
Â  Â  Â  Â  }
Â  Â  Â  Â  .myInput {Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  padding: 8px;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .myGroup {Â 
Â  Â  Â  Â  Â  Â  border: 1px dashed #bbb;Â 
Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  margin-top: 15px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #myPredictionResult {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  min-height: 40px;
Â  Â  Â  Â  Â  Â  color: #008080;
Â  Â  Â  Â  }
Â  Â  Â  Â  #myWaveform {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 50px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  background-color: #eee;
Â  Â  Â  Â  }
Â  Â  </style>
Â  Â Â 
Â  Â  <!-- TensorFlow Libraries -->
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.9/dist/tf-tflite.min.js"></script>
</head>
<body>

Â  Â  <script>
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ðŸš€ USER-CONFIGURABLE MODEL SETTINGS
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  const myModelConfig = {
Â  Â  Â  Â  Â  Â  // Default URL for the wake word model
Â  Â  Â  Â  Â  Â  myDefaultUrl: './tflite/ei-ei-v202-xiao-sounds-0unknown-1no-2yes-esp32-nn-classifier-tensorflow-lite-float32-model.12.tflite',Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Expected sample rate of the TFLite model (standard for EI audio)
Â  Â  Â  Â  Â  Â  mySampleRate: 16000,Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // The length of the audio window (1 second = 16000 samples)
Â  Â  Â  Â  Â  Â  myWindowSizeSamples: 16000,Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Labels matching the model's output index order
Â  Â  Â  Â  Â  Â  myLabels: ['_background_noise_', 'wake_word', 'unknown'],Â 
Â  Â  Â  Â  };

Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // âš™ï¸ INTERNAL VARIABLESÂ 
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  let myTfLiteModel = null;
Â  Â  Â  Â  let myAudioContext = null;
Â  Â  Â  Â  let myStream = null;
Â  Â  Â  Â  let myScriptProcessor = null;
Â  Â  Â  Â  let myAudioBuffer = []; // Buffer for collecting 16000 samples
Â  Â  Â  Â  let mySamplesCollected = 0;

Â  Â  Â  Â  let myStatusElement = null;
Â  Â  Â  Â  let myPredictionElement = null;
Â  Â  Â  Â  let myFileInput = null;
Â  Â  Â  Â  let myUrlInput = null;
Â  Â  Â  Â  let myWaveformCanvas = null;
Â  Â  Â  Â  let myWaveformContext = null;

Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ðŸ  HTML SETUP (Simple DOM Creation)
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myCreateDOM
Â  Â  Â  Â  Â * Initializes all necessary DOM elements.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myCreateDOM() {
Â  Â  Â  Â  Â  Â  const myContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  myContainer.id = 'myContainer';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const myTitle = document.createElement('h1');
Â  Â  Â  Â  Â  Â  myTitle.style.fontSize = '1.5em';
Â  Â  Â  Â  Â  Â  myTitle.style.fontWeight = 'bold';
Â  Â  Â  Â  Â  Â  myTitle.style.marginBottom = '15px';
Â  Â  Â  Â  Â  Â  myTitle.style.textAlign = 'center';
Â  Â  Â  Â  Â  Â  myTitle.textContent = 'Edge Impulse Wake Word Detector';
Â  Â  Â  Â  Â  Â  myContainer.appendChild(myTitle);

Â  Â  Â  Â  Â  Â  myStatusElement = document.createElement('p');
Â  Â  Â  Â  Â  Â  myStatusElement.id = 'myStatusMessage';
Â  Â  Â  Â  Â  Â  myStatusElement.className = 'myStatus';
Â  Â  Â  Â  Â  Â  myStatusElement.textContent = 'Select a model loading method to start.';
Â  Â  Â  Â  Â  Â  myContainer.appendChild(myStatusElement);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Waveform visualizer (minimal)
Â  Â  Â  Â  Â  Â  myWaveformCanvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  myWaveformCanvas.id = 'myWaveform';
Â  Â  Â  Â  Â  Â  myWaveformCanvas.width = 440;
Â  Â  Â  Â  Â  Â  myWaveformCanvas.height = 50;
Â  Â  Â  Â  Â  Â  myContainer.appendChild(myWaveformCanvas);
Â  Â  Â  Â  Â  Â  myWaveformContext = myWaveformCanvas.getContext('2d');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Controls Group ---
Â  Â  Â  Â  Â  Â  const myControlsDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  myControlsDiv.id = 'myControls';

Â  Â  Â  Â  Â  Â  // 1. Load from File
Â  Â  Â  Â  Â  Â  const myFileGroup = document.createElement('div');
Â  Â  Â  Â  Â  Â  myFileGroup.className = 'myGroup';
Â  Â  Â  Â  Â  Â  myFileGroup.style.borderColor = '#008080';
Â  Â  Â  Â  Â  Â  myFileGroup.style.backgroundColor = '#f0faff';

Â  Â  Â  Â  Â  Â  const myFileLabel = document.createElement('p');
Â  Â  Â  Â  Â  Â  myFileLabel.style.fontWeight = 'bold';
Â  Â  Â  Â  Â  Â  myFileLabel.textContent = `1. Load From Computer File (.tflite):`;
Â  Â  Â  Â  Â  Â  myFileGroup.appendChild(myFileLabel);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myFileInput = document.createElement('input');Â 
Â  Â  Â  Â  Â  Â  myFileInput.type = 'file';
Â  Â  Â  Â  Â  Â  myFileInput.id = 'myFileInput';
Â  Â  Â  Â  Â  Â  myFileInput.accept = '.tflite';
Â  Â  Â  Â  Â  Â  myFileInput.style.marginTop = '10px';
Â  Â  Â  Â  Â  Â  myFileInput.onchange = myLoadFromFile;Â 
Â  Â  Â  Â  Â  Â  myFileGroup.appendChild(myFileInput);
Â  Â  Â  Â  Â  Â  myControlsDiv.appendChild(myFileGroup);

Â  Â  Â  Â  Â  Â  // 2. Load from Default URL
Â  Â  Â  Â  Â  Â  const myDefaultUrlButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  myDefaultUrlButton.className = 'myButton';
Â  Â  Â  Â  Â  Â  myDefaultUrlButton.textContent = `2. Load Default URL (${myModelConfig.myDefaultUrl.split('/').pop()})`;
Â  Â  Â  Â  Â  Â  myDefaultUrlButton.onclick = myLoadFromDefaultUrl;
Â  Â  Â  Â  Â  Â  myControlsDiv.appendChild(myDefaultUrlButton);

Â  Â  Â  Â  Â  Â  // 3. Load from Custom URL
Â  Â  Â  Â  Â  Â  const myUrlGroup = document.createElement('div');
Â  Â  Â  Â  Â  Â  myUrlGroup.className = 'myGroup';

Â  Â  Â  Â  Â  Â  const myUrlLabel = document.createElement('p');
Â  Â  Â  Â  Â  Â  myUrlLabel.style.fontWeight = 'bold';
Â  Â  Â  Â  Â  Â  myUrlLabel.textContent = '3. Load From Custom URL:';
Â  Â  Â  Â  Â  Â  myUrlGroup.appendChild(myUrlLabel);

Â  Â  Â  Â  Â  Â  myUrlInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  myUrlInput.type = 'text';
Â  Â  Â  Â  Â  Â  myUrlInput.id = 'myUrlInput';
Â  Â  Â  Â  Â  Â  myUrlInput.value = myModelConfig.myDefaultUrl;Â 
Â  Â  Â  Â  Â  Â  myUrlInput.placeholder = 'Enter .tflite URL here';
Â  Â  Â  Â  Â  Â  myUrlInput.className = 'myInput';
Â  Â  Â  Â  Â  Â  myUrlInput.style.marginTop = '8px';
Â  Â  Â  Â  Â  Â  myUrlGroup.appendChild(myUrlInput);

Â  Â  Â  Â  Â  Â  const myCustomUrlButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  myCustomUrlButton.className = 'myButton';
Â  Â  Â  Â  Â  Â  myCustomUrlButton.textContent = 'Load Custom URL and Start Microphone';
Â  Â  Â  Â  Â  Â  myCustomUrlButton.onclick = myLoadFromCustomUrl;
Â  Â  Â  Â  Â  Â  myUrlGroup.appendChild(myCustomUrlButton);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myControlsDiv.appendChild(myUrlGroup);

Â  Â  Â  Â  Â  Â  // 4. Reset ButtonÂ 
Â  Â  Â  Â  Â  Â  const myResetButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  myResetButton.className = 'myButton';
Â  Â  Â  Â  Â  Â  myResetButton.textContent = 'Reset / Stop Microphone';
Â  Â  Â  Â  Â  Â  myResetButton.onclick = myResetApplication;
Â  Â  Â  Â  Â  Â  myResetButton.style.marginTop = '25px';Â 
Â  Â  Â  Â  Â  Â  myControlsDiv.appendChild(myResetButton);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myContainer.appendChild(myControlsDiv);
Â  Â  Â  Â  Â  Â  document.body.appendChild(myContainer);

Â  Â  Â  Â  Â  Â  // Prediction Result Display
Â  Â  Â  Â  Â  Â  myPredictionElement = document.createElement('p');
Â  Â  Â  Â  Â  Â  myPredictionElement.id = 'myPredictionResult';
Â  Â  Â  Â  Â  Â  myPredictionElement.textContent = 'Inference not started.';
Â  Â  Â  Â  Â  Â  document.body.appendChild(myPredictionElement);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  window.onload = myCreateDOM;Â 

Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ðŸ’» MODEL LOADING AND STARTUP LOGIC
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myGetAllControls
Â  Â  Â  Â  Â * Gets all interactive elements to disable them during loading.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myGetAllControls() {
Â  Â  Â  Â  Â  Â  return [
Â  Â  Â  Â  Â  Â  Â  Â  ...document.querySelectorAll('.myButton'),
Â  Â  Â  Â  Â  Â  Â  Â  myFileInput,
Â  Â  Â  Â  Â  Â  Â  Â  myUrlInput
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myDisableControls
Â  Â  Â  Â  Â * Disables control elements during loading.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myDisableControls(myDisabled) {
Â  Â  Â  Â  Â  Â  myGetAllControls().forEach(myEl => myEl.disabled = myDisabled);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myLoadFromDefaultUrl
Â  Â  Â  Â  Â * Wrapper function to load the model from the configured default URL.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function myLoadFromDefaultUrl() {
Â  Â  Â  Â  Â  Â  await myLoadModelAndStartMic(myModelConfig.myDefaultUrl);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myLoadFromCustomUrl
Â  Â  Â  Â  Â * Wrapper function to load the model from the text input URL.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function myLoadFromCustomUrl() {
Â  Â  Â  Â  Â  Â  const myCustomUrl = myUrlInput.value.trim();
Â  Â  Â  Â  Â  Â  if (myCustomUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  await myLoadModelAndStartMic(myCustomUrl);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  myStatusElement.textContent = 'Error: Please enter a valid URL in the custom URL field.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myLoadFromFile
Â  Â  Â  Â  Â * Handles the change event from the file input to load a local file.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function myLoadFromFile() {
Â  Â  Â  Â  Â  Â  const mySelectedFile = myFileInput.files[0];
Â  Â  Â  Â  Â  Â  if (mySelectedFile) {
Â  Â  Â  Â  Â  Â  Â  Â  await myLoadModelAndStartMic(mySelectedFile);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  myDisableControls(false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  myStatusElement.textContent = 'Please select a .tflite file first or choose another method.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myLoadModelAndStartMic
Â  Â  Â  Â  Â * Main function to load the model (File or URL) and start the microphone.
Â  Â  Â  Â  Â * @param {string|File} mySource - The URL string or the File object.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function myLoadModelAndStartMic(mySource) {
Â  Â  Â  Â  Â  Â  myStopAudioProcessing();Â 
Â  Â  Â  Â  Â  Â  myDisableControls(true);

Â  Â  Â  Â  Â  Â  const mySourceType = typeof mySource === 'string' ? 'URL' : 'File';
Â  Â  Â  Â  Â  Â  const myDisplayPath = typeof mySource === 'string' ? mySource : mySource.name;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myStatusElement.textContent = `Loading model from ${mySourceType}: ${myDisplayPath}...`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let myModelSource = mySource;Â 

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (mySourceType === 'File') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myModelSource = await new Promise((myResolve, myReject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const myReader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myReader.onload = () => myResolve(myReader.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myReader.onerror = myReject;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myReader.readAsArrayBuffer(mySource);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myStatusElement.textContent = `File read into buffer. Loading model...`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  myTfLiteModel = await tflite.loadTFLiteModel(myModelSource);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  myStatusElement.textContent = 'Model loaded successfully! Initializing microphone...';
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`TFLite Model Loaded from ${mySourceType}: ${myDisplayPath}`);

Â  Â  Â  Â  Â  Â  Â  Â  await mySetupMicrophone();

Â  Â  Â  Â  Â  Â  } catch (myError) {
Â  Â  Â  Â  Â  Â  Â  Â  myStatusElement.textContent = `Failed to load model from ${mySourceType}. Check the console (F12) for details.`;
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Model loading error:', myError);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  myDisableControls(false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ðŸŽ¤ MICROPHONE AND AUDIO PROCESSING
Â  Â  Â  Â  // =================================================================

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function mySetupMicrophone
Â  Â  Â  Â  Â * Initializes the Web Audio API and starts mic stream.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function mySetupMicrophone() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Ensure AudioContext is ready (required for some browsers)
Â  Â  Â  Â  Â  Â  Â  Â  if (!myAudioContext) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myAudioContext = new (window.AudioContext || window.webkitAudioContext)();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (myAudioContext.state === 'suspended') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await myAudioContext.resume();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
Â  Â  Â  Â  Â  Â  Â  Â  const myMicSource = myAudioContext.createMediaStreamSource(myStream);

Â  Â  Â  Â  Â  Â  Â  Â  // Create a ScriptProcessorNode to get raw audio data chunks
Â  Â  Â  Â  Â  Â  Â  Â  // Buffer size must be a power of 2 (2048, 4096, 8192, 16384)
Â  Â  Â  Â  Â  Â  Â  Â  myScriptProcessor = myAudioContext.createScriptProcessor(4096, 1, 1);Â 
Â  Â  Â  Â  Â  Â  Â  Â  myScriptProcessor.onaudioprocess = myProcessAudioBuffer;

Â  Â  Â  Â  Â  Â  Â  Â  // Connect nodes: Mic Source -> Script Processor -> Audio Destination
Â  Â  Â  Â  Â  Â  Â  Â  myMicSource.connect(myScriptProcessor);
Â  Â  Â  Â  Â  Â  Â  Â  myScriptProcessor.connect(myAudioContext.destination);

Â  Â  Â  Â  Â  Â  Â  Â  const myActualSampleRate = myAudioContext.sampleRate;
Â  Â  Â  Â  Â  Â  Â  Â  myStatusElement.textContent = `Mic active (Browser Rate: ${myActualSampleRate}Hz). Listening for wake word...`;
Â  Â  Â  Â  Â  Â  Â  Â  myDisableControls(false);Â 

Â  Â  Â  Â  Â  Â  } catch (myError) {
Â  Â  Â  Â  Â  Â  Â  Â  myStatusElement.textContent = `Error accessing microphone: ${myError.message}.`;
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Microphone access error:', myError);
Â  Â  Â  Â  Â  Â  Â  Â  myDisableControls(false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myProcessAudioBuffer
Â  Â  Â  Â  Â * The core loop that receives audio chunks, downsamples, and buffers them.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myProcessAudioBuffer(myAudioEvent) {
Â  Â  Â  Â  Â  Â  // Check if model is loaded and ready
Â  Â  Â  Â  Â  Â  if (!myTfLiteModel || myAudioContext.state !== 'running') return;

Â  Â  Â  Â  Â  Â  const myInputBuffer = myAudioEvent.inputBuffer.getChannelData(0); // Get mono data
Â  Â  Â  Â  Â  Â  const myBrowserRate = myAudioContext.sampleRate;
Â  Â  Â  Â  Â  Â  const myTargetRate = myModelConfig.mySampleRate;
Â  Â  Â  Â  Â  Â  const myRatio = myBrowserRate / myTargetRate;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Temporary array for downsampled samples from this chunk
Â  Â  Â  Â  Â  Â  const myDownsampledChunk = [];

Â  Â  Â  Â  Â  Â  // Simple Downsampling: take every Nth sample
Â  Â  Â  Â  Â  Â  for (let i = 0; i < myInputBuffer.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  if (i % myRatio === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myDownsampledChunk.push(myInputBuffer[i]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Visualization ---
Â  Â  Â  Â  Â  Â  myDrawWaveform(myInputBuffer);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Buffering ---
Â  Â  Â  Â  Â  Â  let myRemainingSamples = myModelConfig.myWindowSizeSamples - mySamplesCollected;
Â  Â  Â  Â  Â  Â  let mySamplesToTake = Math.min(myDownsampledChunk.length, myRemainingSamples);

Â  Â  Â  Â  Â  Â  // Add new samples to the main buffer
Â  Â  Â  Â  Â  Â  for (let i = 0; i < mySamplesToTake; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  myAudioBuffer.push(myDownsampledChunk[i]);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  mySamplesCollected += mySamplesToTake;

Â  Â  Â  Â  Â  Â  // Check if we have a full window (16000 samples)
Â  Â  Â  Â  Â  Â  if (mySamplesCollected >= myModelConfig.myWindowSizeSamples) {
Â  Â  Â  Â  Â  Â  Â  Â  myRunInference();
Â  Â  Â  Â  Â  Â  Â  Â  // Clear and reset the buffer for the next window
Â  Â  Â  Â  Â  Â  Â  Â  myAudioBuffer = [];
Â  Â  Â  Â  Â  Â  Â  Â  mySamplesCollected = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myDrawWaveform
Â  Â  Â  Â  Â * Draws the current audio buffer chunk for visual feedback.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myDrawWaveform(myBuffer) {
Â  Â  Â  Â  Â  Â  const myWidth = myWaveformCanvas.width;
Â  Â  Â  Â  Â  Â  const myHeight = myWaveformCanvas.height;
Â  Â  Â  Â  Â  Â  const myCtx = myWaveformContext;

Â  Â  Â  Â  Â  Â  myCtx.clearRect(0, 0, myWidth, myHeight);
Â  Â  Â  Â  Â  Â  myCtx.fillStyle = '#f0faff';
Â  Â  Â  Â  Â  Â  myCtx.fillRect(0, 0, myWidth, myHeight);
Â  Â  Â  Â  Â  Â  myCtx.strokeStyle = '#008080';
Â  Â  Â  Â  Â  Â  myCtx.lineWidth = 1;

Â  Â  Â  Â  Â  Â  myCtx.beginPath();
Â  Â  Â  Â  Â  Â  const mySliceWidth = myWidth * 1.0 / myBuffer.length;
Â  Â  Â  Â  Â  Â  let x = 0;

Â  Â  Â  Â  Â  Â  for(let i = 0; i < myBuffer.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  // Normalize the audio data (-1 to 1) to the canvas height
Â  Â  Â  Â  Â  Â  Â  Â  const v = myBuffer[i];
Â  Â  Â  Â  Â  Â  Â  Â  const y = myHeight / 2 + v * (myHeight / 2);

Â  Â  Â  Â  Â  Â  Â  Â  if(i === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myCtx.moveTo(x, y);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myCtx.lineTo(x, y);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  x += mySliceWidth;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  myCtx.lineTo(myWidth, myHeight / 2);
Â  Â  Â  Â  Â  Â  myCtx.stroke();
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myRunInference
Â  Â  Â  Â  Â * Runs the TFLite model on the 16000-sample audio window.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myRunInference() {
Â  Â  Â  Â  Â  Â  tf.tidy(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!myTfLiteModel) return;

Â  Â  Â  Â  Â  Â  Â  Â  // 1. Prepare Input Tensor
Â  Â  Â  Â  Â  Â  Â  Â  const myInputArray = new Float32Array(myAudioBuffer);
Â  Â  Â  Â  Â  Â  Â  Â  // Reshape to [1, 16000, 1] for TF Lite audio model
Â  Â  Â  Â  Â  Â  Â  Â  const myInputTensor = tf.tensor(myInputArray).expandDims(0).expandDims(-1);Â 

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Run Inference
Â  Â  Â  Â  Â  Â  Â  Â  const myOutputTensor = myTfLiteModel.predict(myInputTensor);

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Post-processing (Classification)
Â  Â  Â  Â  Â  Â  Â  Â  myPostProcessClassification(myOutputTensor);
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myPostProcessClassification
Â  Â  Â  Â  Â * Interprets the classification output tensor.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myPostProcessClassification(myOutputTensor) {
Â  Â  Â  Â  Â  Â  const myProbabilities = myOutputTensor.dataSync();
Â  Â  Â  Â  Â  Â  const myBestIndex = myProbabilities.indexOf(Math.max(...myProbabilities));
Â  Â  Â  Â  Â  Â  const myBestLabel = myModelConfig.myLabels[myBestIndex];
Â  Â  Â  Â  Â  Â  const myConfidence = myProbabilities[myBestIndex];

Â  Â  Â  Â  Â  Â  let myDisplayResult;
Â  Â  Â  Â  Â  Â  let myDisplayColor;

Â  Â  Â  Â  Â  Â  // Simple threshold to emphasize the wake word
Â  Â  Â  Â  Â  Â  if (myBestLabel === 'wake_word' && myConfidence > 0.75) {
Â  Â  Â  Â  Â  Â  Â  Â  myDisplayResult = `WAKE WORD DETECTED! (${(myConfidence * 100).toFixed(1)}%)`;
Â  Â  Â  Â  Â  Â  Â  Â  myDisplayColor = '#e53e3e'; // Highlight red for success
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  myDisplayResult = `${myBestLabel} (${(myConfidence * 100).toFixed(1)}%)`;
Â  Â  Â  Â  Â  Â  Â  Â  myDisplayColor = '#008080'; // Normal teal
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log(
Â  Â  Â  Â  Â  Â  Â  Â  `Prediction: ${myBestLabel} | Confidence: ${myConfidence.toFixed(4)}`
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myPredictionElement.textContent = myDisplayResult;
Â  Â  Â  Â  Â  Â  myPredictionElement.style.color = myDisplayColor;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myResetApplication
Â  Â  Â  Â  Â * Stops audio processing, clears model reference, resets status, and re-enables controls.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myResetApplication() {
Â  Â  Â  Â  Â  Â  myStopAudioProcessing();
Â  Â  Â  Â  Â  Â  myTfLiteModel = null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myPredictionElement.textContent = 'Inference not started.';
Â  Â  Â  Â  Â  Â  myPredictionElement.style.color = '#008080';
Â  Â  Â  Â  Â  Â  myStatusElement.textContent = 'Application Reset. Select a model loading method to start.';
Â  Â  Â  Â  Â  Â  myDisableControls(false);Â 
Â  Â  Â  Â  Â  Â  console.log('Wake Word Detection app reset.');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function myStopAudioProcessing
Â  Â  Â  Â  Â * Stops the microphone stream and releases resources.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function myStopAudioProcessing() {
Â  Â  Â  Â  Â  Â  if (myStream) {
Â  Â  Â  Â  Â  Â  Â  Â  myStream.getTracks().forEach(track => track.stop());
Â  Â  Â  Â  Â  Â  Â  Â  myStream = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (myAudioContext && myAudioContext.state !== 'closed') {
Â  Â  Â  Â  Â  Â  Â  Â  myAudioContext.close();
Â  Â  Â  Â  Â  Â  Â  Â  myAudioContext = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Clear buffers
Â  Â  Â  Â  Â  Â  myAudioBuffer = [];
Â  Â  Â  Â  Â  Â  mySamplesCollected = 0;
Â  Â  Â  Â  Â  Â  // Clear the visualization
Â  Â  Â  Â  Â  Â  if (myWaveformContext) {
Â  Â  Â  Â  Â  Â  Â  Â  myWaveformContext.clearRect(0, 0, myWaveformCanvas.width, myWaveformCanvas.height);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
