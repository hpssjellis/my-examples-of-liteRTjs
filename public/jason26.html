<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>LiteRT.js Model Logger</title>

    <script type="module">
        import * as LiteRT from 'https://cdn.jsdelivr.net/npm/@litertjs/core@0.2.1/+esm';
        import * as LiteRTInterop from 'https://cdn.jsdelivr.net/npm/@litertjs/tfjs-interop/+esm';
        import 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js';
        import 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgpu/dist/tf-backend-webgpu.js';

        const myDepthModels = [
            {myName: "Depth-Anything V2 Large", myUrl: 'https://huggingface.co/qualcomm/Depth-Anything-V2/resolve/main/Depth-Anything-V2_float.tflite'},
            {myName: "Fomo", myUrl: 'https://hpssjellis.github.io/my-examples-of-liteRTjs/public/tflite/ei-ei-andrew-3d-printed-symbol-fomo-object-detection-tensorflow-lite-float32-model.5.tflite'},
            {myName: "fomo pen", myUrl: 'https://hpssjellis.github.io/my-examples-of-liteRTjs/public/tflite/ei-ei-fomo-pen-object-detection-tensorflow-lite-float32-model.5.tflite'},
            {myName: "brush", myUrl: 'https://hpssjellis.github.io/my-examples-of-liteRTjs/public/tflite/ei-ei-jeremy-0unknown-1brush-2paint-v01-transfer-learning-tensorflow-lite-float32-model.5.tflite'},
            {myName: "96 mnist", myUrl: 'https://hpssjellis.github.io/my-examples-of-liteRTjs/public/tflite/ei-ei-v1-5-0-minst-96x96-f180-object-detection-tensorflow-lite-float32-model.5.tflite'},
            {myName: "Jer Cups", myUrl: 'https://hpssjellis.github.io/my-examples-of-liteRTjs/public/tflite/ei-ei-v8-1-1-jeremy-rc-car-1red-2white-cup-fomo-96x96-object-detection-tensorflow-lite-float32-model.5.tflite'},
            {myName: "anomoly", myUrl: 'https://hpssjellis.github.io/my-examples-of-liteRTjs/public/tflite/ei-ei-v1-motion-anamoly-still-classifier-tensorflow-lite-float32-model.15.tflite'},
            {myName: "pen", myUrl: 'https://hpssjellis.github.io/my-examples-of-liteRTjs/public/tflite/ei-ei-v1-fomo-pen-jeremy-object-detection-tensorflow-lite-float32-model.5.tflite'}
        ];

        // globals
        let myModel;
        let myIsPredicting = false;
        let myCurrentInputShape = 0;
        let myInputChannels = 3;
        let myInputDtype = 'float32';
        let myLiteRTInitializedPromise = null;

        const myVideoElement = document.getElementById('webcam');
        const myLoadButton = document.getElementById('loadModelButton');
        const myResetButton = document.getElementById('myResetButton');
        const myCameraSelect = document.getElementById('cameraSelect');
        const myModelSelect = document.getElementById('modelSelect');
        const myModelUrlInput = document.getElementById('myModelUrlInput');
        const myInputShapeSpan = document.getElementById('myInputShapeStatus');
        const myInputDtypeSpan = document.getElementById('myInputDtypeStatus');
        const myOutputDetailsSpan = document.getElementById('myOutputDetailsStatus');

        async function myInitializeLiteRT() {
            if (myLiteRTInitializedPromise) return myLiteRTInitializedPromise;

            myLiteRTInitializedPromise = (async () => {
                try { await tf.setBackend('webgpu'); }
                catch { try { await tf.setBackend('webgl'); }
                catch { await tf.setBackend('cpu'); }}

                await LiteRT.loadLiteRt('https://cdn.jsdelivr.net/npm/@litertjs/core@0.2.1/wasm/');
                LiteRT.setWebGpuDevice(tf.backend().device);
            })();

            return myLiteRTInitializedPromise;
        }

        async function myEnableWebcam(myId) {
            if (myVideoElement.srcObject) {
                myVideoElement.srcObject.getTracks().forEach(t => t.stop());
                myVideoElement.srcObject = null;
            }
            const myCfg = {video: {deviceId: myId ? {exact: myId} : undefined}};
            const myStream = await navigator.mediaDevices.getUserMedia(myCfg);
            myVideoElement.srcObject = myStream;
            await new Promise(r => myVideoElement.onloadedmetadata = r);
            myVideoElement.play();
        }

        async function myGetCameras() {
            const myDevices = await navigator.mediaDevices.enumerateDevices();
            const myList = myDevices.filter(d => d.kind === "videoinput");
            myCameraSelect.innerHTML = "";
            myList.forEach((d,i)=>{
                const o=document.createElement("option");
                o.value=d.deviceId;
                o.text=`Camera ${i+1}`;
                myCameraSelect.appendChild(o);
            });
        }

        async function myPreLoadModelMetadata() {
            const myUrl = myModelUrlInput.value.trim();
            if (!myUrl) return;

            await myInitializeLiteRT();

            if (myModel) { try { myModel.delete(); } catch {} }
            myModel = await LiteRT.loadAndCompile(myUrl, {accelerator:"webgpu"});

            const myIn = myModel.getInputDetails()[0];
            myCurrentInputShape = myIn.shape[1];
            myInputChannels = myIn.shape[3] || 1;
            myInputDtype = myIn.dtype || "float32";

            myInputShapeSpan.textContent = `${myCurrentInputShape}×${myCurrentInputShape} (${myInputChannels} ch)`;
            myInputDtypeSpan.textContent = myInputDtype;

            const myOut = myModel.getOutputDetails()[0];
            myOutputDetailsSpan.textContent = myOut.shape.join("×");
        }

        async function myLoadModel() {
            await myEnableWebcam(myCameraSelect.value);
            myIsPredicting = true;
            myPredict();
        }

        async function myPredict() {
            if (!myIsPredicting || !myModel) return;

            tf.tidy(() => {
                let myT = tf.browser.fromPixels(myVideoElement);

                if (myInputChannels === 1) myT = myT.mean(2, true);
                myT = myT.resizeBilinear([myCurrentInputShape, myCurrentInputShape]);

                if (myInputDtype.startsWith("float")) myT = myT.div(255);
                else myT = myT.cast(myInputDtype);

                myT = myT.expandDims();

                const myResults = LiteRTInterop.runWithTfjsTensors(myModel, myT);

                // ⭐ NEW: PRINT MODEL OUTPUT
                for (let i = 0; i < myResults.length; i++) {
                    console.log("====== MODEL OUTPUT", i, "======");
                    console.log("dtype:", myResults[i].dtype);
                    console.log("shape:", myResults[i].shape);
                    console.log("values:", myResults[i].dataSync());
                }

                myResults.forEach(r => r.dispose());
            });

            requestAnimationFrame(myPredict);
        }

        function myFullReset() {
            myIsPredicting = false;
            if (myModel) { try { myModel.delete(); } catch {} }
            myModel = null;
        }

        myLoadButton.onclick = myLoadModel;
        myResetButton.onclick = myFullReset;
        myCameraSelect.onchange = ()=>myEnableWebcam(myCameraSelect.value);
        myModelSelect.onchange = ()=>{
            myModelUrlInput.value = myModelSelect.value;
            myPreLoadModelMetadata();
        };
        myModelUrlInput.onchange = myPreLoadModelMetadata;

        myPopulate();
        function myPopulate() {
            myDepthModels.forEach(m=>{
                const o=document.createElement("option");
                o.value=m.myUrl;
                o.text=m.myName;
                myModelSelect.appendChild(o);
            });
            myModelUrlInput.value = myDepthModels[0].myUrl;
            myPreLoadModelMetadata();
        }

        myInitializeLiteRT();
        myGetCameras();
        myEnableWebcam();
    </script>
</head>

<body style="margin:0; padding:10px; background:#000; color:#fff; font-family:sans-serif;">
    <div style="background:#fff; color:#000; padding:10px; border-radius:8px;">
        <div>
            Camera:
            <select id="cameraSelect"></select>
        </div>

        <div>
            Model Preset:
            <select id="modelSelect"></select>
        </div>

        <input type="text" id="myModelUrlInput" style="width:95%; padding:5px;" />

        <button id="loadModelButton">Load & Start</button>
        <button id="myResetButton" style="background:#fcc;">Reset</button>

        <div style="font-size:12px; margin-top:10px;">
            Input: <span id="myInputShapeStatus">N/A</span><br>
            DType: <span id="myInputDtypeStatus">N/A</span><br>
            Output: <span id="myOutputDetailsStatus">N/A</span>
        </div>
    </div>

    <video id="webcam" autoplay playsinline style="width:300px; margin-top:10px;"></video>
</body>
</html>
