
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFLite Model Inspector</title>
    
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: #f5f5f5; 
            padding: 20px;
            margin: 0;
            line-height: 1.5;
        }
        .container { max-width: 900px; margin: 0 auto; }
        
        .card { 
            background: white; 
            padding: 24px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .status { 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 16px; 
            border-left: 4px solid;
        }
        .status-info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
        .status-loaded { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
        .status-error { background: #ffebee; border-color: #f44336; color: #c62828; }

        input[type="text"], input[type="file"] { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        button { 
            width: 100%; 
            padding: 12px; 
            border: none;
            border-radius: 4px; 
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-primary:hover { background: #6d28d9; }
        .btn-secondary { background: #2563eb; color: white; margin-top: 20px; }
        .btn-secondary:hover { background: #1d4ed8; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        h1 { 
            font-size: 28px; 
            font-weight: 700; 
            text-align: center; 
            color: #1f2937; 
            margin: 0 0 8px 0; 
        }
        h2 { 
            font-size: 20px; 
            font-weight: 600; 
            color: #6d28d9; 
            margin: 0 0 16px 0;
        }
        h3 { 
            font-size: 16px; 
            font-weight: 600; 
            color: #374151; 
            margin: 20px 0 8px 0;
        }
        
        label { 
            display: block; 
            font-size: 13px; 
            font-weight: 500; 
            color: #4b5563; 
            margin-bottom: 6px; 
        }
        
        .subtitle { 
            font-size: 14px; 
            color: #6b7280; 
            text-align: center; 
            margin-bottom: 24px; 
        }

        .code-block { 
            background: #f3f4f6; 
            padding: 12px; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 13px;
            overflow-x: auto;
            margin-top: 8px;
        }

        .divider { 
            text-align: center; 
            margin: 12px 0; 
            font-style: italic;
            color: #9ca3af;
        }
        
        hr { 
            border: none; 
            border-top: 1px solid #e5e7eb; 
            margin: 24px 0; 
        }

        ul { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        li { 
            padding: 8px 0; 
            border-bottom: 1px solid #f3f4f6; 
        }
        li:last-child { border-bottom: none; }

        .hidden { display: none; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.9/dist/tf-tflite.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>TFLite Model Inspector</h1>
        <p class="subtitle">Load a .tflite file and inspect its structure and output</p>

        <!-- Section 1: Load Model -->
        <div class="card">
            <h2>1. Load Model</h2>
            <div id="model-status" class="status status-info">Awaiting model file or URL...</div>

            <label for="model-file">Load from Local File (.tflite)</label>
            <input type="file" id="model-file" accept=".tflite">

            <p class="divider">— OR —</p>

            <label for="model-url">Load from URL</label>
            <input type="text" id="model-url" placeholder="https://example.com/model.tflite">
            
            <button onclick="loadModel()" id="load-button" class="btn-primary">
                Load and Inspect Model
            </button>
        </div>

        <!-- Section 2: Inspection -->
        <div id="inspection-section" class="card hidden">
            <h2>2. Model Signature</h2>
            
            <div id="input-summary" class="status status-info">Input: N/A</div>
            <div id="output-summary" class="status status-info">Output: N/A</div>
            
            <hr>
            
            <h3>Topology</h3>
            <div id="layer-count-summary" class="status status-info">Operations: N/A</div>
            <div class="code-block">
                <ul id="layer-details-list">
                    <li>Waiting for model...</li>
                </ul>
            </div>
            <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
                Note: Layer extraction uses non-public API properties
            </p>

            <hr>

            <h3>Test Inference</h3>
            <label for="input-shape">Input Shape (auto-detected)</label>
            <input type="text" id="input-shape" placeholder="Will auto-populate from model">
            
            <button onclick="runInference()" id="run-button" class="btn-secondary" disabled>
                Run Test Inference
            </button>
        </div>

        <!-- Section 3: Results -->
        <div id="output-section" class="card hidden">
            <h2>3. Inference Results</h2>
            <div id="inference-status" class="status status-info">Run inference to see results</div>
            
            <div id="output-shape-result" class="code-block">Output Shape: N/A</div>
            <div id="output-data-preview" class="code-block">Data Preview: N/A</div>
        </div>
    </div>

    <script>
        let tfliteModel = null;
        const statusEl = document.getElementById('model-status');
        const loadBtn = document.getElementById('load-button');
        const runBtn = document.getElementById('run-button');
        const inspectionSection = document.getElementById('inspection-section');
        const outputSection = document.getElementById('output-section');
        const modelFileEl = document.getElementById('model-file'); 
        const modelUrlEl = document.getElementById('model-url'); 
        const inputShapeEl = document.getElementById('input-shape');
        const inputSummaryEl = document.getElementById('input-summary');
        const outputSummaryEl = document.getElementById('output-summary');
        const outputShapeResultEl = document.getElementById('output-shape-result');
        const outputDataPreviewEl = document.getElementById('output-data-preview');
        const inferenceStatusEl = document.getElementById('inference-status');
        const layerCountSummaryEl = document.getElementById('layer-count-summary');
        const layerDetailsListEl = document.getElementById('layer-details-list');

        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status status-${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function resetView() {
            tfliteModel = null;
            inspectionSection.classList.add('hidden');
            outputSection.classList.add('hidden');
            inputSummaryEl.textContent = 'Input: N/A';
            outputSummaryEl.textContent = 'Output: N/A';
            layerCountSummaryEl.textContent = 'Operations: N/A';
            layerDetailsListEl.innerHTML = '<li>Waiting for model...</li>';
            outputShapeResultEl.textContent = 'Output Shape: N/A';
            outputDataPreviewEl.textContent = 'Data Preview: N/A';
            inferenceStatusEl.textContent = 'Run inference to see results';
            inputShapeEl.value = '';
            runBtn.disabled = true;
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function getLayerDetails(model) {
            let layerInfo = [];
            let layerCount = 0;

            try {
                const tfliteExecutor = model.executor && model.executor.tflite; 
                const graph = tfliteExecutor && tfliteExecutor.graph;
                
                if (graph && graph.nodes) {
                    for (const nodeName in graph.nodes) {
                        const node = graph.nodes[nodeName];
                        layerInfo.push({ name: nodeName, op: node.op });
                        layerCount++;
                    }
                } else {
                    layerInfo = [{ op: "WARNING", name: "Graph structure not found" }];
                }
            } catch (e) {
                console.error("Error parsing model structure:", e);
                layerInfo = [{ op: "ERROR", name: e.message }];
            }

            return { count: layerCount, layers: layerInfo };
        }

        async function loadModel() {
            resetView();
            loadBtn.disabled = true;

            const selectedFile = modelFileEl.files[0];
            const url = modelUrlEl.value.trim();
            let modelSource = null;

            if (selectedFile) {
                updateStatus(`Reading file: ${selectedFile.name}...`, 'info');
                try {
                    modelSource = await readFileAsArrayBuffer(selectedFile);
                    modelUrlEl.value = ''; 
                } catch (error) {
                    updateStatus(`File read error: ${error.message}`, 'error');
                    loadBtn.disabled = false;
                    return;
                }
            } else if (url) {
                updateStatus(`Loading from URL: ${url}...`, 'info');
                modelSource = url;
                modelFileEl.value = ''; 
            } else {
                updateStatus('Please select a file or enter a URL', 'error');
                loadBtn.disabled = false;
                return;
            }

            try {
                if (typeof tflite.setWasmPath === 'function') {
                    tflite.setWasmPath('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.9/dist/');
                }

                tfliteModel = await tflite.loadTFLiteModel(modelSource);
                updateStatus('Model loaded successfully', 'loaded');
                loadBtn.disabled = false;
                
                console.log("Model inputs:", tfliteModel.inputs);
                console.log("Model outputs:", tfliteModel.outputs);
                console.log("Full model:", tfliteModel);
                
                inspectionSection.classList.remove('hidden');
                runBtn.disabled = false;
                inspectModel();

            } catch (error) {
                updateStatus(`Load error: ${error.message}`, 'error');
                console.error("TFLite error:", error);
                loadBtn.disabled = false;
            }
        }

        function inspectModel() {
            if (!tfliteModel) return;

            // Input signature
            if (tfliteModel.inputs && tfliteModel.inputs.length > 0) {
                const input = tfliteModel.inputs[0];
                inputSummaryEl.textContent = `Input: ${input.name} | Shape: [${input.shape ? input.shape.join(', ') : '?'}] | Type: ${input.dtype}`;
                
                // Auto-populate shape
                if (input.shape && input.shape.length > 0) {
                    const autoShape = input.shape.map(dim => dim === -1 ? 1 : dim);
                    inputShapeEl.value = autoShape.join(', ');
                    console.log(`Auto-detected shape: [${autoShape.join(', ')}]`);
                }
            } else {
                inputSummaryEl.textContent = 'Input: No inputs defined';
                inputSummaryEl.className = 'status status-error';
            }
            
            // Output signature
            if (tfliteModel.outputs && tfliteModel.outputs.length > 0) {
                const output = tfliteModel.outputs[0];
                outputSummaryEl.textContent = `Output: ${output.name} | Shape: [${output.shape ? output.shape.join(', ') : '?'}] | Type: ${output.dtype}`;
            } else {
                outputSummaryEl.textContent = 'Output: No outputs defined';
                outputSummaryEl.className = 'status status-error';
            }

            // Topology
            const topology = getLayerDetails(tfliteModel);
            layerCountSummaryEl.textContent = `Operations: ${topology.count}`;
            layerDetailsListEl.innerHTML = '';

            if (topology.layers.length > 0 && topology.layers[0].op !== "WARNING") {
                topology.layers.slice(0, 5).forEach(layer => {
                    const li = document.createElement('li');
                    li.textContent = `${layer.op}: ${layer.name}`;
                    layerDetailsListEl.appendChild(li);
                });
                
                if (topology.layers.length > 5) {
                    const li = document.createElement('li');
                    li.style.fontStyle = 'italic';
                    li.textContent = `... ${topology.layers.length - 5} more (see console)`;
                    layerDetailsListEl.appendChild(li);
                }
            } else {
                layerDetailsListEl.innerHTML = '<li>Could not extract layers</li>';
            }
        }

        function runInference() {
            if (!tfliteModel) {
                inferenceStatusEl.textContent = 'Model not loaded';
                inferenceStatusEl.className = 'status status-error';
                return;
            }

            const shapeString = inputShapeEl.value.trim();
            if (!shapeString) {
                inferenceStatusEl.textContent = 'Please specify input shape';
                inferenceStatusEl.className = 'status status-error';
                return;
            }

            const inputShape = shapeString.split(',').map(s => parseInt(s.trim()));

            if (inputShape.some(dim => isNaN(dim) || dim <= 0)) {
                inferenceStatusEl.textContent = 'Invalid shape (must be positive integers)';
                inferenceStatusEl.className = 'status status-error';
                return;
            }

            inferenceStatusEl.textContent = `Running inference with shape [${inputShape.join(', ')}]...`;
            inferenceStatusEl.className = 'status status-info';
            runBtn.disabled = true;

            try {
                tf.tidy(() => {
                    const totalElements = inputShape.reduce((a, b) => a * b, 1);
                    const mockData = Array.from({ length: totalElements }, () => Math.random() * 2 - 1);
                    const inputTensor = tf.tensor(mockData, inputShape, 'float32');
                    
                    console.log("Input tensor:", inputTensor);

                    const outputTensor = tfliteModel.predict(inputTensor);
                    
                    console.log("Output tensor:", outputTensor);

                    outputSection.classList.remove('hidden');

                    const outputShape = outputTensor.shape;
                    const outputData = outputTensor.dataSync();

                    outputShapeResultEl.textContent = `Output Shape: [${outputShape.join(', ')}]`;
                    outputDataPreviewEl.textContent = `Preview: [${Array.from(outputData).slice(0, 10).map(v => v.toFixed(4)).join(', ')}${outputData.length > 10 ? ', ...' : ''}]`;

                    inferenceStatusEl.textContent = 'Inference complete';
                    inferenceStatusEl.className = 'status status-loaded';
                });
            } catch (error) {
                inferenceStatusEl.textContent = `Error: ${error.message}`;
                inferenceStatusEl.className = 'status status-error';
                console.error("Inference error:", error);
            } finally {
                runBtn.disabled = false;
                tf.disposeVariables();
            }
        }

        modelFileEl.addEventListener('change', () => {
            if (modelFileEl.files.length > 0) {
                modelUrlEl.value = ''; 
                loadModel();
            }
        });
    </script>
</body>
</html>
